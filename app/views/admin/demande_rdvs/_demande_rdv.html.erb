<div id="<%= dom_id demande_rdv %>" class="my-2">
  <div class="card mx-2 mb-3 light-beige-colored shadow-sm">
    <div class="card-body p-1">
      <div class="card-title d-flex align-items-center">
        <div>
          <%= link_to "#collapseDemande#{dom_id(demande_rdv)}", 
              class: "text-decoration-none text-dark", 
              "data-bs-toggle": "collapse", 
              role: "button", 
              "aria-expanded": "false", 
              "aria-controls": "collapseDemande#{dom_id(demande_rdv)}" do %>
            <%= custom_badge("", "", "", "fw-bold", demande_rdv.full_name) if demande_rdv.nom.present? %>
          <% end %>
        </div>
        <%= badge_statut_demande_cabine(demande_rdv.statut) %>
        <%= custom_badge("fa-calendar", "", "", "", " envoyée le #{demande_rdv.created_at.strftime('%d/%m/%Y %H:%M')}") %>
        <%= custom_badge("fa-calendar-check", "", "", "", demande_rdv.date_rdv.strftime('%d/%m/%Y à %H:%M')) if demande_rdv.date_rdv.present? && demande_rdv.date_rdv.respond_to?(:strftime) %>
        <% if demande_rdv.demande_cabine_essayage&.produits&.any? %>
          <div class="badge lighter-beige-colored fw-normal m-1 fs-6 shadow-sm text-warning text-break" style="white-space: normal;">
            <i class="bi bi-cart-check me-1"></i>
            <%= demande_rdv.demande_cabine_essayage.produits.count %> produit<%= 's' if demande_rdv.demande_cabine_essayage.produits.count > 1 %>
          </div>
        <% end %>

        <%= link_to "", "#collapseDemande#{dom_id(demande_rdv)}", 
              class: "btn btn-sm btn-outline-primary bi bi-eye m-1", "data-bs-toggle": "collapse", 
              role: "button", "aria-expanded": "false", "aria-controls": "collapseDemande#{dom_id(demande_rdv)}" %>

        <div class="ms-auto d-flex align-items-center">
          <%= button_to("", edit_admin_demande_rdv_path(demande_rdv), method: :post, class: "btn btn-sm btn-secondary bi bi-pencil-square m-0") %> 
        </div>
      </div>

      <div class="collapse py-1 px-2" id="collapseDemande<%= dom_id(demande_rdv) %>">

        <hr>

        <%= field_with_label("Prénom: ", demande_rdv.prenom) if demande_rdv.prenom.present? %>
        <%= field_with_label("Nom: ", demande_rdv.nom) if demande_rdv.nom.present? %>
        <%= field_with_label("Email: ", demande_rdv.email) if demande_rdv.email.present? %>
        <%= field_with_label("Téléphone: ", demande_rdv.telephone) if demande_rdv.telephone.present? %>
        <%= field_with_label("Date RDV: ", demande_rdv.date_rdv.strftime('%d/%m/%Y à %H:%M')) if demande_rdv.date_rdv.present? && demande_rdv.date_rdv.respond_to?(:strftime) %>
        <% if demande_rdv.type_rdv.present? %>
          <% type_rdv_label = demande_rdv.type_rdv.to_s.titleize %>
          <%= field_with_label("Type de RDV: ", type_rdv_label) %>
        <% end %>
        <%= field_with_label("Nombre de personnes: ", demande_rdv.nombre_personnes) if demande_rdv.nombre_personnes.present? %>
        <% if demande_rdv.type_rdv.present? %>
          <%= field_with_label("Durée du RDV: ", demande_rdv.duree_rdv_formatee) %>
        <% end %>
        <%= field_with_label("Statut: ", demande_rdv.statut) if demande_rdv.statut.present? %>
        <%= field_with_label("Commentaire: ", demande_rdv.commentaire) if demande_rdv.commentaire.present? %>
        <%= field_with_label("Événement: ", demande_rdv.evenement) if demande_rdv.evenement.present? %>
        <%= field_with_label("Date événement: ", demande_rdv.date_evenement&.strftime('%d/%m/%Y')) if demande_rdv.date_evenement.present? %>

        <%# Afficher les produits si une cabine d'essayage est associée %>
        <% if demande_rdv.demande_cabine_essayage&.produits&.any? %>
          <hr>
          <h6 class="fw-bold small text-muted">Produits demandés (cabine d'essayage):</h6>
          <div class="row g-2">
            <% demande_rdv.demande_cabine_essayage.produits.each do |produit| %>
              <div class="col-12 col-md-6 col-lg-4">
                <%= link_to admin_produit_path(produit), class: "text-decoration-none", data: { turbo: false } do %>
                  <div class="card p-1 light-beige-colored shadow-sm">
                    <div class="d-flex align-items-center">
                      <div class="me-1">
                        <%= image_tag(produit.default_image, width: 40, class: "rounded") %>
                      </div>
                      <div class="flex-grow-1" style="min-width: 0;">
                        <h6 class="mb-0 fw-bold small text-dark" style="font-size: 0.85rem;"><%= produit.nom %></h6>
                        <div class="d-flex flex-wrap gap-1 mt-1">
                          <%= badge_taille_produit(produit) if produit.taille.present? %>
                          <%= badge_couleur_produit(produit) if produit.couleur.present? %>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>

      </div>

    </div>

  </div>

</div>

