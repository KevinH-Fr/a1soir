<%= form_with model: demande_cabine_essayage, url: demande_cabine_essayages_path, class: "needs-validation cabine-reservation-form", data: { controller: "recaptcha-submit" } do |form| %>
  
  <% if demande_cabine_essayage.errors.any? %>
    <div class="alert alert-danger">
      <h6><%= pluralize(demande_cabine_essayage.errors.count, "erreur") %> ont empêché l'enregistrement :</h6>
      <ul class="mb-0">
        <% demande_cabine_essayage.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Coordonnées -->
  <h5 class="text-light mb-3">
    <i class="bi bi-person public-brand-color me-2"></i>Coordonnées
  </h5>
  <div class="row mb-2">
    <div class="col-md-6 mb-2">
      <%= form.text_field :prenom, class: "form-control bg-dark text-light border-secondary placeholder-light", placeholder: "Prénom" %>
    </div>
    <div class="col-md-6 mb-2">
      <%= form.text_field :nom, class: "form-control bg-dark text-light border-secondary placeholder-light", placeholder: "Nom *", required: true %>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6 mb-2">
      <%= form.email_field :mail, class: "form-control bg-dark text-light border-secondary placeholder-light", placeholder: "Email *", required: true %>
    </div>
    <div class="col-md-6 mb-2">
      <%= form.text_field :telephone, class: "form-control bg-dark text-light border-secondary placeholder-light", placeholder: "Téléphone *", required: true %>
    </div>
  </div>

  <!-- Événement -->
  <h5 class="text-light mb-3 mt-4">
    <i class="bi bi-calendar-event public-brand-color me-2"></i>Votre événement
  </h5>
  <div class="row mb-3">
    <div class="col-md-6 mb-2">
      <%= form.select :evenement, 
          options_for_select([
            ["Mariage", "mariage"],
            ["Soirée", "soiree"],
            ["Shooting", "shooting"],
            ["Autre", "autre"]
          ], demande_cabine_essayage.evenement),
          { prompt: "Type d'événement" },
          { class: "form-select bg-dark text-light border-secondary placeholder-light", required: false } %>
    </div>
    <div class="col-md-6 mb-2">
      <%= form.date_field :date_evenement, class: "form-control bg-dark text-light border-secondary", required: false %>
    </div>
  </div>

  <!-- Disponibilités -->
  <div class="mb-4">
    <div class="d-flex align-items-center gap-2 mb-2">
      <i class="bi bi-clock-history public-brand-color"></i>
      <h5 class="text-light mb-0">Vos disponibilités</h5>
    </div>
    <p class="text-light opacity-75 small mb-3">
      Sélectionnez les créneaux qui vous conviennent pour un rendez-vous.
    </p>

    <% jours = [
      ["mardi", "Mardi"],
      ["mercredi", "Mercredi"],
      ["jeudi", "Jeudi"],
      ["vendredi", "Vendredi"],
      ["samedi", "Samedi"]
    ] %>

    <% creneaux = [
      ["matin", "Matin"],
      ["apres_midi", "Après-midi"],
      ["fin_de_journee", "Fin de journée"]
    ] %>

    <% disponibilites_selectionnees = Array(form.object.disponibilites) %>

    <div class="table-responsive rounded-3 overflow-hidden border border-secondary-subtle">
      <table class="table table-sm table-dark align-middle mb-0">
        <thead class="bg-black-50">
          <tr class="small">
            <th scope="col" class="ps-3 fw-bold text-light text-uppercase">Jour</th>
            <% creneaux.each do |slug, label| %>
              <th scope="col" class="fw-bold text-light text-center"><%= label %></th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% jours.each do |jour_slug, jour_label| %>
            <tr>
              <th scope="row" class="ps-3 text-light fw-normal"><%= jour_label %></th>
              <% creneaux.each do |creneau_slug, label| %>
                <% valeur = "#{jour_slug}_#{creneau_slug}" %>
                <% checkbox_id = "demande_cabine_essayage_disponibilites_#{valeur}" %>
                <td class="text-center align-middle">
                  <div class="form-check d-inline-flex justify-content-center mb-0">
                    <%= form.check_box :disponibilites,
                        {
                          multiple: true,
                          class: "form-check-input",
                          id: checkbox_id,
                          checked: disponibilites_selectionnees.include?(valeur)
                        },
                        valeur,
                        nil %>
                    <label class="visually-hidden" for="<%= checkbox_id %>"><%= "#{jour_label} - #{label}" %></label>
                  </div>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Produits sélectionnés - Hidden fields only -->
  <% if demande_cabine_essayage.demande_cabine_essayage_items.size > 0 %>
    <%= form.fields_for :demande_cabine_essayage_items do |item_form| %>
      <% if item_form.object.produit_id.present? %>
        <%= item_form.hidden_field :produit_id %>
      <% end %>
    <% end %>
  <% end %>

  <!-- Commentaires -->
  <div class="mb-3">
    <%= form.text_area :commentaires, rows: 4, class: "form-control bg-dark text-light border-secondary placeholder-light", 
        placeholder: "Message (optionnel)" %>
  </div>

  <!-- reCAPTCHA -->
  <div class="mb-3" data-recaptcha-submit-target="recaptcha">
    <%= recaptcha_tags theme: 'dark', callback: 'onRecaptchaSuccess', expired_callback: 'onRecaptchaExpired', error_callback: 'onRecaptchaError' %>
  </div>

  <!-- Boutons -->
  <div class="d-flex gap-3 mb-3 justify-content-end">
    <div id="recaptcha-warning" data-recaptcha-submit-target="warning" class="alert alert-warning py-2 px-3 mb-0 me-3" style="display: none;">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <small>Veuillez compléter le reCAPTCHA</small>
    </div>
    <button type="submit" id="submit-btn" data-recaptcha-submit-target="submitBtn" data-action="click->recaptcha-submit#trySubmit" class="btn btn-lg px-5 shadow btn-secondary disabled" disabled style="opacity: 0.6; cursor: not-allowed;">
      <i class="bi bi-lock me-2"></i>Validez d'abord le reCAPTCHA
    </button>
  </div>


<% end %>
